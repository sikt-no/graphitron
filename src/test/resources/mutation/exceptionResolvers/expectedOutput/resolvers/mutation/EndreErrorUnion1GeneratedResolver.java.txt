package no.fellesstudentsystem.graphql.resolvers.mutation;

import graphql.schema.DataFetchingEnvironment;
import java.lang.Exception;
import java.lang.Override;
import java.lang.String;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.CompletableFuture;
import java.util.stream.Collectors;
import javax.inject.Inject;
import no.fellesstudentsystem.graphitron.exceptions.TestException;
import no.fellesstudentsystem.graphitron.services.TestPersonService;
import no.fellesstudentsystem.graphql.generated.api.EndreErrorUnion1MutationResolver;
import no.fellesstudentsystem.graphql.generated.model.EndreErrorsUnion1;
import no.fellesstudentsystem.graphql.generated.model.EndreResponse2;
import no.fellesstudentsystem.graphql.generated.model.EndreResponse3;
import no.fellesstudentsystem.graphql.generated.model.EndreResponseUnion1;
import no.fellesstudentsystem.graphql.generated.model.PersonProfil;
import no.fellesstudentsystem.graphql.generated.model.SomeErrorA;
import no.fellesstudentsystem.graphql.helpers.selection.SelectionSets;
import no.fellesstudentsystem.graphql.queries.query.PersonProfilDBQueries;
import org.jooq.DSLContext;

public class EndreErrorUnion1GeneratedResolver implements EndreErrorUnion1MutationResolver {
    @Inject
    DSLContext ctx;

    @Inject
    private PersonProfilDBQueries personProfilDBQueries;

    @Override
    public CompletableFuture<EndreResponseUnion1> endreErrorUnion1(String navn,
            DataFetchingEnvironment env) throws Exception {
        var testPersonService = new TestPersonService(ctx);
        var select = new SelectionSets(env.getSelectionSet());

        no.fellesstudentsystem.graphitron.services.TestPersonService.EndrePersonResponse endreErrorUnion1Result = null;
        var endreErrorsUnion1List = new ArrayList<EndreErrorsUnion1>();
        try {
            endreErrorUnion1Result = testPersonService.endreErrorUnion1(navn);
        } catch (TestException e) {
            var error = new SomeErrorA();
            error.setMessage(e.getMessage());
            error.setPath(List.of("endreErrorUnion1"));
            endreErrorsUnion1List.add(error);
        }

        if (endreErrorUnion1Result == null) {
            var endreResponseUnion1 = new EndreResponseUnion1();
            endreResponseUnion1.setErrors(endreErrorsUnion1List);
            return CompletableFuture.completedFuture(endreResponseUnion1);
        }

        var endreResponse2Result = endreErrorUnion1Result.getEndreResponse2();
        var endreResponse3Result = endreErrorUnion1Result.getEndreResponse3();

        var endreResponse2PersonProfil = getEndreResponse2PersonProfil(endreResponse2Result, select);
        var endreResponse3PersonProfil = getEndreResponse3PersonProfil(endreResponse3Result, select);

        var endreResponseUnion1 = new EndreResponseUnion1();
        endreResponseUnion1.setId(endreErrorUnion1Result.getId());

        var endreResponse2 = new EndreResponse2();
        endreResponse2.setId(endreResponse2Result.getId2());
        endreResponse2.setPersonProfil(endreResponse2PersonProfil);
        endreResponseUnion1.setEndreResponse2(endreResponse2);

        var endreResponse3List = new ArrayList<EndreResponse3>();
        for (var itEndreResponse3Result : endreResponse3Result) {
            var endreResponse3 = new EndreResponse3();
            endreResponse3.setId(itEndreResponse3Result.getId3());
            endreResponse3.setPersonProfil(endreResponse3PersonProfil.get(endreResponse3.getId()));
            endreResponse3List.add(endreResponse3);
        }
        endreResponseUnion1.setEndreResponse3(endreResponse3List);
        endreResponseUnion1.setErrors(endreErrorsUnion1List);

        return CompletableFuture.completedFuture(endreResponseUnion1);
    }

    private PersonProfil getEndreResponse2PersonProfil(
            no.fellesstudentsystem.graphitron.services.TestPersonService.EndrePersonResponse2 result,
            SelectionSets select) {
        if (!select.contains("endreResponse2/personProfil") || result == null) {
            return null;
        }

        var nodes = personProfilDBQueries.loadPersonProfilByIdsAsNode(Set.of(result.getPersonProfil().getId()), select.withPrefix("endreResponse2/personProfil"));
        return nodes.values().stream().findFirst().orElse(null);
    }

    private Map<String, PersonProfil> getEndreResponse3PersonProfil(
            List<no.fellesstudentsystem.graphitron.services.TestPersonService.EndrePersonResponse3> result,
            SelectionSets select) {
        if (!select.contains("endreResponse3/personProfil") || result == null) {
            return Map.of();
        }

        var ids = result.stream().map(it -> it.getPers3().getId()).collect(Collectors.toSet());
        return personProfilDBQueries.loadPersonProfilByIdsAsNode(ids, select.withPrefix("endreResponse3/personProfil"));
    }
}
