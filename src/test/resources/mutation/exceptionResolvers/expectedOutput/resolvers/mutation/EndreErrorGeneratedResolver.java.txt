package fake.code.example.package.resolvers.mutation;

import graphql.schema.DataFetchingEnvironment;
import java.lang.Exception;
import java.lang.Override;
import java.lang.String;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.CompletableFuture;
import java.util.stream.Collectors;
import javax.inject.Inject;
import no.fellesstudentsystem.graphitron.exceptions.TestExceptionCause;
import no.fellesstudentsystem.graphitron.services.TestPersonService;
import fake.graphql.example.package.api.EndreErrorMutationResolver;
import fake.graphql.example.package.model.EndreInput;
import fake.graphql.example.package.model.EndreResponse;
import fake.graphql.example.package.model.EndreResponse2;
import fake.graphql.example.package.model.EndreResponse3;
import fake.graphql.example.package.model.PersonProfil;
import fake.graphql.example.package.model.SomeErrorB;
import no.fellesstudentsystem.graphql.helpers.arguments.Arguments;
import no.fellesstudentsystem.graphql.helpers.selection.SelectionSet;
import fake.code.example.package.queries.query.PersonProfilDBQueries;
import no.fellesstudentsystem.kjerneapi.FieldHelpers;
import no.fellesstudentsystem.kjerneapi.tables.records.PersonRecord;
import org.jooq.DSLContext;

public class EndreErrorGeneratedResolver implements EndreErrorMutationResolver {
    @Inject
    DSLContext ctx;

    @Inject
    private PersonProfilDBQueries personProfilDBQueries;

    @Override
    public CompletableFuture<EndreResponse> endreError(EndreInput input,
            DataFetchingEnvironment env) throws Exception {
        var testPersonService = new TestPersonService(ctx);
        var select = new SelectionSet(env.getSelectionSet());
        var flatArguments = Arguments.flattenArgumentKeys(env.getArguments());

        var inputRecord = new PersonRecord();
        inputRecord.attach(ctx.configuration());
        var endre2Record = new PersonRecord();
        endre2Record.attach(ctx.configuration());

        if (input != null) {
            var endre2 = input.getEndre2();
            if (endre2 != null) {
                if (flatArguments.contains("input/endre2/privatEpost")) {
                    endre2Record.setEmailadressePrivat(endre2.getPrivatEpost());
                }
                FieldHelpers.setPersonKeysFromPlattformIds(ctx, endre2Record);
            }
            if (flatArguments.contains("input/id")) {
                inputRecord.setId(input.getId());
            }
            if (flatArguments.contains("input/navn")) {
                inputRecord.setFornavn(input.getNavn());
            }
            if (flatArguments.contains("input/etternavn")) {
                inputRecord.setEtternavn(input.getEtternavn());
            }
            FieldHelpers.setPersonKeysFromPlattformIds(ctx, inputRecord);
        }

        no.fellesstudentsystem.graphitron.services.TestPersonService.EndrePersonResponse endreErrorResult = null;
        var someErrorBList = new ArrayList<SomeErrorB>();
        try {
            endreErrorResult = testPersonService.endreError(inputRecord, endre2Record);
        } catch (TestExceptionCause e) {
            var error = new SomeErrorB();
            error.setMessage(e.getMessage());
            var cause = e.getCauseField();
            var causeName = Map.of("EMAILADRESSE_PRIVAT", "EndreInput.EndreInput2.privatEpost", "ID", "EndreInput.id", "ETTERNAVN", "EndreInput.etternavn", "FORNAVN", "EndreInput.navn").getOrDefault(cause != null ? cause : "", "undefined");
            error.setPath(List.of(("Mutation.endreError." + causeName).split("\\.")));
            someErrorBList.add(error);
        }

        if (endreErrorResult == null) {
            var endreResponse = new EndreResponse();
            endreResponse.setErrors(someErrorBList);
            return CompletableFuture.completedFuture(endreResponse);
        }

        var endreResponse2Result = endreErrorResult.getEndreResponse2();
        var endreResponse3Result = endreErrorResult.getEndreResponse3();

        var endreResponse2PersonProfil = getEndreResponse2PersonProfil(endreResponse2Result, select);
        var endreResponse3PersonProfil = getEndreResponse3PersonProfil(endreResponse3Result, select);

        var endreResponse = new EndreResponse();
        endreResponse.setId(endreErrorResult.getId());

        var endreResponse2 = new EndreResponse2();
        endreResponse2.setId(endreResponse2Result.getId2());
        endreResponse2.setPersonProfil(endreResponse2PersonProfil);
        endreResponse.setEndreResponse2(endreResponse2);

        var endreResponse3List = new ArrayList<EndreResponse3>();
        for (var itEndreResponse3Result : endreResponse3Result) {
            var endreResponse3 = new EndreResponse3();
            endreResponse3.setId(itEndreResponse3Result.getId3());
            endreResponse3.setPersonProfil(endreResponse3PersonProfil.get(endreResponse3.getId()));
            endreResponse3List.add(endreResponse3);
        }
        endreResponse.setEndreResponse3(endreResponse3List);
        endreResponse.setErrors(someErrorBList);

        return CompletableFuture.completedFuture(endreResponse);
    }

    private PersonProfil getEndreResponse2PersonProfil(
            no.fellesstudentsystem.graphitron.services.TestPersonService.EndrePersonResponse2 idContainer,
            SelectionSet select) {
        if (!select.contains("endreResponse2/personProfil") || idContainer == null) {
            return null;
        }

        var nodes = personProfilDBQueries.loadPersonProfilByIdsAsNode(Set.of(idContainer.getPersonProfil().getId()), select.withPrefix("endreResponse2/personProfil"));
        return nodes.values().stream().findFirst().orElse(null);
    }

    private Map<String, PersonProfil> getEndreResponse3PersonProfil(
            List<no.fellesstudentsystem.graphitron.services.TestPersonService.EndrePersonResponse3> idContainer,
            SelectionSet select) {
        if (!select.contains("endreResponse3/personProfil") || idContainer == null) {
            return Map.of();
        }

        var ids = idContainer.stream().map(it -> it.getPers3().getId()).collect(Collectors.toSet());
        return personProfilDBQueries.loadPersonProfilByIdsAsNode(ids, select.withPrefix("endreResponse3/personProfil"));
    }
}
